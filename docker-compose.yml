version: '3.8'

networks:
  backend-net:
    driver: bridge

services:
  # ====================================================================================================================
  # 锔 SERVICIOS DE INFRAESTRUCTURA (Keycloak, Eureka, PostgreSQL, PgAdmin)
  # ====================================================================================================================
  
  # Eureka Discovery Server
  eureka-server:
    build: #  Usa tu c贸digo fuente
      context: ./eureka-server #  Aseg煤rate que la ruta a tu proyecto Eureka sea correcta
      dockerfile: Dockerfile
    container_name: eureka-server
    ports:
      - "8761:8761"
    networks:
      - backend-net
    environment:
      # Estos se mantienen para asegurar la configuraci贸n en el contenedor
      SPRING_APPLICATION_NAME: eureka-server
      EUREKA_SERVER_PORT: 8761
      EUREKA_INSTANCE_HOSTNAME: eureka-server

  # PostgreSQL Database
  postgres:
    image: postgres:16
    container_name: postgres
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: tpi_db
      PGDATA: /var/lib/postgresql/data/pgdata
      TZ: America/Argentina/Buenos_Aires
      PGTZ: America/Argentina/Buenos_Aires
    volumes:
      - ./pgdata:/var/lib/postgresql/data/pgdata
      # Asumo que tus archivos schema.sql y data.sql est谩n en ./db/scripts
      - ./db/scripts/schema.sql:/docker-entrypoint-initdb.d/10-schema.sql
      - ./db/scripts/data.sql:/docker-entrypoint-initdb.d/20-data.sql
    ports:
      - "5432:5432"
    networks:
      - backend-net
    restart: unless-stopped
  
  # PgAdmin (Gestor de DB)
  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin
    user: root
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@tpi.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    ports:
      - "5050:80"
    networks:
      - backend-net
    depends_on:
      - postgres
    restart: unless-stopped
    
  # Keycloak (Servidor de Seguridad)
  keycloak:
    image: quay.io/keycloak/keycloak:23.0.7
    container_name: keycloak
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/tpi_db
      KC_DB_USERNAME: user
      KC_DB_PASSWORD: password
      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: 9090
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
      KC_HTTP_PORT: 8080
      KC_PROXY: edge
    command: start-dev --import-realm
    volumes:
      - ./config/keycloak/tpi-realm-realm.json:/opt/keycloak/data/import/tpi-realm-realm.json
    ports:
      - "9090:8080" # Puerto para acceder a la UI de Keycloak
    networks:
      - backend-net
    depends_on:
      - postgres
    restart: unless-stopped

  # ====================================================================================================================
  #  MICROSERVICIOS (Eureka Clients)
  # ====================================================================================================================
    # API Gateway
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      SPRING_APPLICATION_NAME: API-GATEWAY
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER-URI: http://keycloak:8080/realms/tpi-realm
    networks:
      - backend-net
    depends_on:
      - eureka-server
      - keycloak

  # ====================================================================================================================
  #  MICROSERVICIOS V2 (Nueva Arquitectura con Bounded Contexts)
  # ====================================================================================================================

  # Microservicio Solicitudes V2 (Clientes + Solicitudes + Contenedores)
  ms-solicitudes-v2:
    build:
      context: ./ms-solicitudes-v2
      dockerfile: Dockerfile
    container_name: ms-solicitudes-v2
    ports:
      - "8091:8091"
    environment:
      SPRING_APPLICATION_NAME: MS-SOLICITUDES-V2
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/tpi_db
      SPRING_DATASOURCE_USERNAME: user
      SPRING_DATASOURCE_PASSWORD: password
    networks:
      - backend-net
    depends_on:
      postgres:
        condition: service_healthy
      eureka-server:
        condition: service_started

  # Microservicio Log铆stica V2 (Transportistas + Camiones + Dep贸sitos + Tramos)
  ms-logistica:
    build:
      context: ./ms-logistica
      dockerfile: Dockerfile
    container_name: ms-logistica
    ports:
      - "8092:8092"
    environment:
      SPRING_APPLICATION_NAME: MS-LOGISTICA
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/tpi_db
      SPRING_DATASOURCE_USERNAME: user
      SPRING_DATASOURCE_PASSWORD: password
      GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY:-AIzaSyDummy_Key_For_Development}
    networks:
      - backend-net
    depends_on:
      - postgres
      - eureka-server

  # Microservicio Facturaci贸n V2 (Tarifas + Facturas + Estad铆as)
  ms-facturacion-v2:
    build:
      context: ./ms-facturacion-v2
      dockerfile: Dockerfile
    container_name: ms-facturacion-v2
    ports:
      - "8093:8093"
    environment:
      SPRING_APPLICATION_NAME: MS-FACTURACION-V2
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/tpi_db
      SPRING_DATASOURCE_USERNAME: user
      SPRING_DATASOURCE_PASSWORD: password
    networks:
      - backend-net
    depends_on:
      - postgres
      - eureka-server

  # Microservicio Tracking V2 (Eventos de Seguimiento)
  ms-tracking-v2:
    build:
      context: ./ms-tracking-v2
      dockerfile: Dockerfile
    container_name: ms-tracking-v2
    ports:
      - "8094:8094"
    environment:
      SPRING_APPLICATION_NAME: MS-TRACKING-V2
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/tpi_db
      SPRING_DATASOURCE_USERNAME: user
      SPRING_DATASOURCE_PASSWORD: password
    networks:
      - backend-net
    depends_on:
      - postgres
      - eureka-server

volumes:
  pgadmin-data:
